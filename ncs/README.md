# MouthPad^ USB – Nordic Connect SDK (nRF52840)

This directory contains the **nRF52840 firmware** for the MouthPad^ USB bridge, built with Nordic Connect SDK (NCS) and Zephyr RTOS.

## Overview

The nRF52840 firmware is the **primary production firmware** that ships on Seeed XIAO nRF52840 hardware. It bridges BLE HID + NUS traffic from the MouthPad^ wearable to USB HID + dual CDC interfaces.

**Key features:**
- BLE HID client + Nordic UART Service (NUS)
- USB HID device (mouse + consumer control)
- Dual USB CDC ports (NUS tunnel + maintenance console)
- Bond management and pairing support
- UF2 bootloader support for easy firmware updates
- LED status feedback
- Console commands: `dfu`, `clear`, `serial`

## Supported Hardware

| Board | Status | Notes |
|-------|--------|-------|
| **Seeed XIAO nRF52840** (`xiao_ble`) | ✅ Production | Ships on production hardware |
| **Adafruit Feather nRF52840** (`adafruit_feather_nrf52840`) | ⚠️ Experimental | Requires custom bootloader config |
| **Nordic nRF52840 Dongle** (`nrf52840dongle`) | ⚠️ Experimental | PCA10059 with nordic/april variants |

## Quick Start

### Docker Build (Recommended)

```bash
cd ncs
docker-compose run --rm mouthpad-build
```

The build produces `build/app/zephyr/zephyr.uf2` ready for drag-and-drop flashing.

### Native Build (with local NCS toolchain)

```bash
cd ncs

# First time: initialize workspace
make init

# Build for default board (xiao_ble)
make build

# Flash via UF2 bootloader
make flash-uf2

# Or flash via J-Link
make flash
```

**Board-specific builds:**
```bash
make build-xiao           # Seeed XIAO nRF52840
make build-feather        # Adafruit Feather nRF52840
make build-nordic-dongle  # Nordic PCA10059 (stock pins)
make build-april-dongle   # April Brothers (non-standard LED)
```

See the [Makefile](Makefile) for all available targets.

## Workspace Structure

```
ncs/
├── app/                    # Application source and board configs
│   ├── src/                # C source files
│   ├── boards/             # Board-specific overlays
│   ├── prj.conf            # Project Kconfig
│   └── README.md           # Detailed app documentation
├── Makefile                # Build helpers
├── west.yml                # West manifest (NCS dependencies)
├── docker-compose.yml      # Containerized builds
├── Dockerfile              # Build container definition
└── bootloaders/            # Pre-built UF2 bootloaders

# Generated by `make init` or `west update`:
├── .west/                  # West workspace metadata
├── nrf/                    # NCS SDK
├── zephyr/                 # Zephyr RTOS
├── nrfxlib/                # Nordic libraries
├── modules/                # Zephyr modules
└── build/                  # Build output
```

**Note:** The generated directories (`.west/`, `nrf/`, `zephyr/`, etc.) are ignored by git and managed by the `west` tool.

## Detailed Documentation

- **[app/README.md](app/README.md)** – Application architecture, build instructions, CDC commands, LED states
- **[Makefile](Makefile)** – Build targets and helper commands
- **[docker-compose.yml](docker-compose.yml)** – Docker build configuration
- **[../docs/BUILD_METHODS.md](../docs/BUILD_METHODS.md)** – Alternative Zephyr build flows
- **[../docs/ADAFRUIT_FEATHER_BOOTLOADER.md](../docs/ADAFRUIT_FEATHER_BOOTLOADER.md)** – Feather bootloader setup

## Flashing Firmware

### UF2 Method (Recommended)

1. **Enter bootloader mode:**
   - Double-tap the reset button
   - Or type `dfu` in the maintenance console

2. **Copy firmware:**
   - Drag `build/app/zephyr/zephyr.uf2` to the bootloader drive
   - **XIAO:** `/Volumes/XIAO-SENSE` (macOS) or `/media/XIAO-SENSE` (Linux)
   - **Feather:** `/Volumes/FTHR840BOOT` (macOS) or `/media/FTHR840BOOT` (Linux)
   - **Nordic Dongle:** `/Volumes/NRF52BOOT` (macOS) or `/media/NRF52BOOT` (Linux)

3. **Automatic reboot:** Device resets automatically after copy completes

### J-Link Method

```bash
make flash
```

Requires J-Link probe connected and J-Link software installed.

## CDC Maintenance Console

The second CDC port (`/dev/cu.usbmodem<serial>3` on macOS, `/dev/ttyACM1` on Linux) provides a maintenance console with these commands:

| Command | Description |
|---------|-------------|
| `dfu` | Reboot into UF2 bootloader |
| `clear` | Clear BLE bonds and return to pairing mode |
| `serial` | Print USB serial number used in device names |

## LED States

| State | Behavior |
|-------|----------|
| **Scanning** | Slow blink (seeking MouthPad^) |
| **Connected** | Solid on |
| **Activity** | Fast flicker when forwarding HID data |

NeoPixel LEDs (if available) show battery-dependent colors when connected.

## Development

### Prerequisites

- **Docker:** For containerized builds (no local toolchain needed)
- **OR Native:** NCS v3.1.0+ with Zephyr SDK and `west` on PATH

### Build System

- **`make`** – High-level wrapper around `west build`
- **`west`** – Nordic's meta-tool for managing NCS workspace
- **Docker** – Isolated builds with pre-configured toolchain

Run `make help` for all available targets.

### Debugging

**RTT Console:**
```bash
make monitor
```

Or use Segger RTT Viewer for better experience.

**GDB:**
```bash
west debug
```

Requires J-Link probe connected.

## CI/CD

GitHub Actions builds all board variants on every push:
- Seeed XIAO nRF52840
- Adafruit Feather nRF52840
- Nordic nRF52840 Dongle (nordic + april variants)

Artifacts are uploaded as `mouthpad^usb_<board>_<commit>.uf2` files.

See [`.github/workflows/ci.yml`](../.github/workflows/ci.yml) for the full workflow.

## Troubleshooting

**Build fails:**
- Ensure workspace is initialized: `make init`
- Clean and rebuild: `make clean && make build`

**Flash fails:**
- Check bootloader is mounted
- Verify UF2 file exists: `ls -l build/app/zephyr/zephyr.uf2`

**Device not detected:**
- Check USB cable supports data (not just charging)
- Try different USB port
- Check system logs: `dmesg` (Linux) or Console.app (macOS)

**BLE connection fails:**
- Clear bonds: type `clear` in maintenance console
- Restart MouthPad^ wearable
- Check LED is blinking (scanning mode)

For more help, see [app/README.md](app/README.md) or open an issue.

## License

MIT License – See [../LICENSE](../LICENSE) for details.
