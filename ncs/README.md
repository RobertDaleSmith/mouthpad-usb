# MouthPad^ USB – Nordic Connect SDK (nRF52840)

This directory contains the **nRF52840 firmware** for the MouthPad^ USB bridge, built with Nordic Connect SDK (NCS) and Zephyr RTOS.

## Overview

The nRF52840 firmware is the **primary production firmware** that ships on Seeed XIAO nRF52840 hardware. It bridges BLE HID + NUS traffic from the MouthPad^ wearable to USB HID + dual CDC interfaces.

**Key features:**
- BLE HID client + Nordic UART Service (NUS)
- USB HID device (mouse + consumer control)
- Dual USB CDC ports (NUS tunnel + maintenance console)
- Bond management and pairing support
- UF2 bootloader support (most boards) or Nordic DFU bootloader (CX-40)
- LED status feedback
- Console commands: `dfu`, `clear`, `serial`

## Supported Hardware

| Board | Status | Notes | Purchase |
|-------|--------|-------|----------|
| **Seeed XIAO nRF52840** (`seeed_xiao_nrf52840`) | ✅ Production | Primary shipping target ([expansion board](https://www.seeedstudio.com/Seeeduino-XIAO-Expansion-board-p-4746.html) supported) | [Seeed Studio](https://www.seeedstudio.com/Seeed-XIAO-BLE-nRF52840-p-5201.html) |
| **Adafruit Feather nRF52840** (`adafruit_feather_nrf52840`) | ✅ Production | Requires custom bootloader config | [Adafruit](https://www.adafruit.com/product/4062) |
| **Nordic nRF52840 Dongle** (`nordic_nrf52840dongle`) | ✅ Production | PCA10059 with stock Nordic LED pins | [Digi-Key](https://www.digikey.com/en/products/detail/nordic-semiconductor-asa/NRF52840-DONGLE/9491124) |
| **Apr Brother nRF52840 Dongle** (`aprbrother_nrf52840`) | ✅ Production | PCA10059 with non-standard LED wiring | [Apr Brother](https://store.aprbrother.com/product/usb-dongle-nrf52840) |
| **Raytac MDBT50Q-RX Dongle** (`raytac_mdbt50q_rx`) | ✅ Production | UF2 bootloader, single LED | [Raytac](https://www.raytac.com/product/ins.php?index_id=89) |
| **Raytac MDBT50Q-CX-40 Dongle** (`raytac_mdbt50q_cx_40`) | ✅ Production | Nordic DFU bootloader, blue+red LEDs | [Raytac](https://www.raytac.com/product/ins.php?index_id=100) |
| **MakerDiary nRF52840 MDK USB Dongle** (`makerdiary_nrf52840mdk`) | ✅ Production | Compact dongle with RGB LED | [MakerDiary](https://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/purchase/) |

## Quick Start

### Docker Build (Recommended)

```bash
cd ncs
docker-compose run --rm mouthpad-build
```

The build produces `build/app/zephyr/zephyr.uf2` ready for drag-and-drop flashing.

### Native Build (with local NCS toolchain)

```bash
cd ncs

# First time: initialize workspace
make init

# Build for default board (xiao_ble)
make build

# Flash via UF2 bootloader
make flash-uf2

# Or flash via J-Link
make flash
```

**Board-specific builds:**
```bash
make build-xiao              # Seeed XIAO nRF52840
make build-feather           # Adafruit Feather nRF52840
make build-nordic-dongle     # Nordic PCA10059 (stock pins)
make build-april-dongle      # Apr Brother (non-standard LED)
make build-raytac-rx         # Raytac MDBT50Q-RX (UF2)
make build-raytac-cx40       # Raytac MDBT50Q-CX-40 (Nordic DFU)
make build-makerdiary-dongle # MakerDiary nRF52840 MDK (RGB LED)
```

See the [Makefile](Makefile) for all available targets.

## Workspace Structure

```
ncs/
├── app/                    # Application source and board configs
│   ├── src/                # C source files
│   ├── boards/             # Board-specific overlays
│   ├── prj.conf            # Project Kconfig
│   └── README.md           # Detailed app documentation
├── Makefile                # Build helpers
├── west.yml                # West manifest (NCS dependencies)
├── docker-compose.yml      # Containerized builds
├── Dockerfile              # Build container definition
└── bootloaders/            # Pre-built UF2 bootloaders

# Generated by `make init` or `west update`:
├── .west/                  # West workspace metadata
├── nrf/                    # NCS SDK
├── zephyr/                 # Zephyr RTOS
├── nrfxlib/                # Nordic libraries
├── modules/                # Zephyr modules
└── build/                  # Build output
```

**Note:** The generated directories (`.west/`, `nrf/`, `zephyr/`, etc.) are ignored by git and managed by the `west` tool.

## Detailed Documentation

- **[app/README.md](app/README.md)** – Application architecture, build instructions, CDC commands, LED states
- **[Makefile](Makefile)** – Build targets and helper commands
- **[docker-compose.yml](docker-compose.yml)** – Docker build configuration
- **[../resources/notes/BUILD_METHODS.md](../resources/notes/BUILD_METHODS.md)** – Alternative Zephyr build flows
- **[../resources/notes/ADAFRUIT_FEATHER_BOOTLOADER.md](../resources/notes/ADAFRUIT_FEATHER_BOOTLOADER.md)** – Feather bootloader setup

## Flashing Firmware

### UF2 Method (Recommended)

1. **Enter bootloader mode:**
   - Double-tap the reset button
   - Or type `dfu` in the maintenance console

2. **Copy firmware:**
   - Drag `build/app/zephyr/zephyr.uf2` to the bootloader drive
   - **XIAO:** `/Volumes/XIAO-SENSE` (macOS) or `/media/XIAO-SENSE` (Linux)
   - **Feather:** `/Volumes/FTHR840BOOT` (macOS) or `/media/FTHR840BOOT` (Linux)
   - **Nordic Dongle:** `/Volumes/NRF52BOOT` (macOS) or `/media/NRF52BOOT` (Linux)
   - **Raytac Dongle:** `/Volumes/MDBT50QBOOT` (macOS) or `/media/MDBT50QBOOT` (Linux)
   - **MakerDiary Dongle:** `/Volumes/UF2BOOT` (macOS) or `/media/UF2BOOT` (Linux)

3. **Automatic reboot:** Device resets automatically after copy completes

### J-Link Method

```bash
make flash
```

Requires J-Link probe connected and J-Link software installed.

### Nordic DFU Method (CX-40 only)

The Raytac CX-40 uses Nordic's DFU bootloader instead of UF2. You can flash it via command line or GUI:

**Command Line (nrfutil):**
```bash
# Build firmware first
make build-raytac-cx40

# Flash via DFU (prompts for bootloader mode)
make flash-dfu
```

**GUI (nRF Connect for Desktop - Recommended):**
1. Download [nRF Connect for Desktop](https://www.nordicsemi.com/Products/Development-tools/nRF-Connect-for-Desktop)
2. Install the "Programmer" app
3. Put device in bootloader mode (hold RESET while connecting USB)
4. Select device in nRF Connect Programmer
5. Add the `.zip` file from `build/app/zephyr/` (after running `make flash-dfu` to generate it)
6. Click "Write" to flash firmware

The device will automatically reboot with the new firmware.

## CDC Maintenance Console

The second CDC port (`/dev/cu.usbmodem<serial>3` on macOS, `/dev/ttyACM1` on Linux) provides a maintenance console with these commands:

| Command | Description |
|---------|-------------|
| `dfu` | Reboot into UF2 bootloader |
| `clear` | Clear BLE bonds and return to pairing mode |
| `serial` | Print USB serial number used in device names |

## LED States

| State | Behavior |
|-------|----------|
| **Scanning** | Slow blink (seeking MouthPad^) |
| **Connected** | Solid on |
| **Activity** | Fast flicker when forwarding HID data |

NeoPixel LEDs (if available) show battery-dependent colors when connected.

## Development

### Prerequisites

- **Docker:** For containerized builds (no local toolchain needed)
- **OR Native:** NCS v3.1.0+ with Zephyr SDK and `west` on PATH

### Build System

- **`make`** – High-level wrapper around `west build`
- **`west`** – Nordic's meta-tool for managing NCS workspace
- **Docker** – Isolated builds with pre-configured toolchain

Run `make help` for all available targets.

### Debugging

**RTT Console:**
```bash
make monitor
```

Or use Segger RTT Viewer for better experience.

**GDB:**
```bash
west debug
```

Requires J-Link probe connected.

## CI/CD

GitHub Actions builds all board variants on every push:
- Seeed XIAO nRF52840
- Adafruit Feather nRF52840
- Nordic nRF52840 Dongle
- Apr Brother nRF52840 Dongle
- Raytac MDBT50Q-RX Dongle
- Raytac MDBT50Q-CX-40 Dongle
- MakerDiary nRF52840 MDK USB Dongle

Artifacts are uploaded as:
- `mp_usb_<board>_<commit>.uf2` for UF2 bootloader boards
- `mp_usb_<board>_<commit>.zip` for Nordic DFU bootloader boards (CX-40)

See [`.github/workflows/ci.yml`](../.github/workflows/ci.yml) for the full workflow.

## Troubleshooting

**Build fails:**
- Ensure workspace is initialized: `make init`
- Clean and rebuild: `make clean && make build`

**Flash fails:**
- Check bootloader is mounted
- Verify UF2 file exists: `ls -l build/app/zephyr/zephyr.uf2`

**Device not detected:**
- Check USB cable supports data (not just charging)
- Try different USB port
- Check system logs: `dmesg` (Linux) or Console.app (macOS)

**BLE connection fails:**
- Clear bonds: type `clear` in maintenance console
- Restart MouthPad^ wearable
- Check LED is blinking (scanning mode)

For more help, see [app/README.md](app/README.md) or open an issue.

## License

MIT License – See [../LICENSE](../LICENSE) for details.
