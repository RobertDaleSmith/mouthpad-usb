/*
 * Copyright (c) 2025 Robert Dale Smith
 * Copyright (c) 2025 Augmental Tech
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/* April Brothers nRF52840 Dongle overlay for MouthPad^USB
 * Hardware based on PCA10059 with Adafruit nRF52 Bootloader
 * Pin mappings from: https://wiki.aprbrother.com/en/BleUsbDongle.html
 */

/* Add PWM pinctrl configuration for optional buzzer */
&pinctrl {
	pwm1_default: pwm1_default {
		group1 {
			psels = <NRF_PSEL(PWM_OUT0, 0, 4)>; /* P0.04 - unused pin for optional buzzer */
		};
	};

	pwm1_sleep: pwm1_sleep {
		group1 {
			psels = <NRF_PSEL(PWM_OUT0, 0, 4)>;
			low-power-enable;
		};
	};
};

&pwm1 {
	status = "okay";
	pinctrl-0 = <&pwm1_default>;
	pinctrl-1 = <&pwm1_sleep>;
	pinctrl-names = "default", "sleep";
};

/* Override existing LED GPIO pins to match April Brothers pinout
 * The base board defines led0_green, led1_red, led1_green, led1_blue
 * We override their GPIO assignments to use the RGB LED (LED2)
 *
 * April Brothers wiki says: Red=P0.08, Green=P1.09, Blue=P0.12
 * Test pattern revealed actual physical LED mapping:
 *   Code RED -> Physical BLUE (P0.08)
 *   Code GREEN -> Physical RED (P1.09)
 *   Code BLUE -> Physical GREEN (P0.12)
 *
 * Correct mapping (swap code channels to get right colors):
 *   led0 (red in code) -> P1.09 (physical red)
 *   led1 (green in code) -> P0.12 (physical green)
 *   led2 (blue in code) -> P0.08 (physical blue)
 */
&led0_green {
	gpios = <&gpio1 9 GPIO_ACTIVE_LOW>;  /* Code red -> Physical red (P1.09) */
	label = "LED Red";
};

&led1_red {
	gpios = <&gpio0 12 GPIO_ACTIVE_LOW>;  /* Code green -> Physical green (P0.12) */
	label = "LED Green";
};

&led1_green {
	gpios = <&gpio0 8 GPIO_ACTIVE_LOW>;  /* Code blue -> Physical blue (P0.08) */
	label = "LED Blue";
};

/* Disable standalone LED1 for sanity check */
&led1_blue {
	status = "disabled";
};

/* Override button to match April Brothers pinout (P1.06) */
&button0 {
	gpios = <&gpio1 6 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
	label = "Push button switch SW1";
};

/ {
	chosen {
		nordic,nus-uart = &cdc_acm_uart0;  /* BLE NUS bridge uses CDC0 */
		zephyr,console = &cdc_acm_uart1;   /* Console/logs on CDC1 */
		zephyr,shell-uart = &cdc_acm_uart1;
	};

	aliases {
		buzzer-pwm = &pwm1;
	};

	/* HID device node */
	hid_dev_0: hid_dev_0 {
		compatible = "zephyr,hid-device";
		label = "MouthPad^HID";
		protocol-code = "mouse";
		in-report-size = <64>;
		in-polling-period-us = <1000>;
	};

	/* Optional buzzer device */
	buzzer {
		compatible = "pwm-buzzer";
		pwms = <&pwm1 0 1000000 PWM_POLARITY_NORMAL>; /* 1MHz base period */
		label = "Passive Buzzer";
	};
};

/* Disable board's default CDC node */
&board_cdc_acm_uart {
	status = "disabled";
};

/* Add dual CDC ACM nodes */
&zephyr_udc0 {
	cdc_acm_uart0: cdc_acm_uart0 {
		compatible = "zephyr,cdc-acm-uart";
		label = "CDC_ACM_0";
	};

	cdc_acm_uart1: cdc_acm_uart1 {
		compatible = "zephyr,cdc-acm-uart";
		label = "CDC_ACM_1";
	};
};

/* Custom partition layout for UF2 bootloader without MCUboot
 * The April Brothers dongle has NO SoftDevice, boots directly from 0x1000
 */

/delete-node/ &boot_partition;
/delete-node/ &slot0_partition;
/delete-node/ &slot1_partition;
/delete-node/ &storage_partition;

&flash0 {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		/* MBR at 0x0 is reserved by Nordic */

		/* Application starts at 0x1000 (after MBR) */
		code_partition: partition@1000 {
			label = "code_partition";
			reg = <0x00001000 0x000d9000>;  /* ~868 KB */
		};

		/* Settings storage before bootloader */
		storage_partition: partition@da000 {
			label = "storage";
			reg = <0x000da000 0x00006000>;  /* 24 KB */
		};

		/* UF2 bootloader at end of flash */
		boot_partition: partition@e0000 {
			label = "uf2_boot";
			reg = <0x000e0000 0x00020000>;  /* 128 KB */
		};
	};
};

/ {
	chosen {
		zephyr,code-partition = &code_partition;
		zephyr,settings-partition = &storage_partition;
	};
};