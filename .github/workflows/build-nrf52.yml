name: Build (nRF52)

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'ncs/**'
      - '.github/workflows/build-nrf52.yml'
  push:
    branches: [ main ]
    paths:
      - 'ncs/**'
      - '.github/workflows/build-nrf52.yml'
  workflow_dispatch:
    inputs:
      board:
        description: 'Target board'
        required: false
        default: 'seeed_xiao_nrf52840'
        type: choice
        options:
        - seeed_xiao_nrf52840
        - adafruit_feather_nrf52840
        - nordic_nrf52840dongle
        - aprbrother_nrf52840
        - makerdiary_nrf52840mdk

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/ci:v0.26.6
    env:
      CMAKE_PREFIX_PATH: /opt/toolchains
    strategy:
      matrix:
        board: [seeed_xiao_nrf52840, adafruit_feather_nrf52840, nordic_nrf52840dongle, aprbrother_nrf52840, raytac_mdbt50q_rx, raytac_mdbt50q_cx_40, makerdiary_nrf52840mdk]
        include:
          - board: seeed_xiao_nrf52840
            description: "Seeed XIAO nRF52840"
            board_target: xiao_ble
            overlay: seeed_xiao_nrf52840.overlay
            conf: seeed_xiao_nrf52840.conf
          - board: adafruit_feather_nrf52840
            description: "Adafruit Feather nRF52840 Express"
            board_target: adafruit_feather_nrf52840
          - board: nordic_nrf52840dongle
            description: "Nordic nRF52840 Dongle (PCA10059)"
            board_target: nrf52840dongle
            overlay: nordic_nrf52840dongle.overlay
            conf: nordic_nrf52840dongle.conf
          - board: aprbrother_nrf52840
            description: "Apr Brother nRF52840 Dongle"
            board_target: nrf52840dongle
            overlay: aprbrother_nrf52840.overlay
            conf: aprbrother_nrf52840.conf
          - board: raytac_mdbt50q_rx
            description: "Raytac MDBT50Q-RX Dongle"
            board_target: nrf52840dongle
            overlay: raytac_mdbt50q_rx.overlay
            conf: raytac_mdbt50q_rx.conf
          - board: raytac_mdbt50q_cx_40
            description: "Raytac MDBT50Q-CX-40 (Nordic DFU)"
            board_target: raytac_mdbt50q_cx_40/nrf52840
            overlay: raytac_mdbt50q_cx_40.overlay
            conf: raytac_mdbt50q_cx_40.conf
            uses_dfu: true
          - board: makerdiary_nrf52840mdk
            description: "MakerDiary nRF52840 MDK USB Dongle"
            board_target: nrf52840dongle
            overlay: makerdiary_nrf52840mdk.overlay
            conf: makerdiary_nrf52840mdk.conf

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: üíæ Cache Zephyr Workspace
        id: cache-workspace
        uses: actions/cache@v4
        with:
          path: /zephyr_workspace
          key: zephyr-workspace-ncs-v3.1.0-${{ runner.os }}
          restore-keys: |
            zephyr-workspace-ncs-v3.1.0-

      - name: ‚ôªÔ∏è Initialize Zephyr Workspace
        if: steps.cache-workspace.outputs.cache-hit != 'true'
        run: |
          mkdir -p /zephyr_workspace
          cd /zephyr_workspace
          west init -m https://github.com/nrfconnect/sdk-nrf.git --mr v3.1.0
          west update --narrow -o=--depth=1

      - name: üìÅ Copy App and Board Files to Workspace
        run: |
          rm -rf /zephyr_workspace/app
          rm -rf /zephyr_workspace/build
          # Create app directory structure matching local layout
          mkdir -p /zephyr_workspace/ncs
          cp -r ncs/app /zephyr_workspace/ncs/app
          cp VERSION /zephyr_workspace/VERSION
          # Symlink for compatibility with build commands
          ln -s /zephyr_workspace/ncs/app /zephyr_workspace/app

      - name: üíæ Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-v1-${{ runner.os }}-${{ matrix.board }}-${{ github.sha }}
          restore-keys: |
            ccache-v1-${{ runner.os }}-${{ matrix.board }}-
            ccache-v1-${{ runner.os }}-

      - name: üî® Build Project
        run: |
          cd /zephyr_workspace
          ccache -z

          # Build with overlay/conf if specified, otherwise use board defaults
          if [ -n "${{ matrix.overlay }}" ]; then
            echo "Building ${{ matrix.description }} with custom overlay/conf"
            west build \
                --board ${{ matrix.board_target }} \
                --pristine=always app \
                -- \
                -DBOARD_ROOT="/zephyr_workspace/ncs/app" \
                -DDTC_OVERLAY_FILE="/zephyr_workspace/ncs/app/boards/${{ matrix.overlay }}" \
                -DEXTRA_CONF_FILE="/zephyr_workspace/ncs/app/boards/${{ matrix.conf }}"
          else
            echo "Building ${{ matrix.description }} with board defaults"
            west build \
                --board ${{ matrix.board_target }} \
                --pristine=always app \
                -- \
                -DBOARD_ROOT="/zephyr_workspace/ncs/app"
          fi

          ccache -sv

      - name: üì¶ Prepare Firmware Artifacts
        run: |
          cd /zephyr_workspace
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          # Clean up any old firmware files from cached workspace
          rm -f mp_usb_*.uf2 mp_usb_*.zip

          # Check if this board uses DFU (Nordic bootloader)
          if [ "${{ matrix.uses_dfu }}" = "true" ]; then
            echo "üì¶ Creating DFU package for ${{ matrix.board }}..."
            # Install nrfutil if not present
            pip3 install --user nrfutil >/dev/null 2>&1 || true
            # Create DFU package (application-version must be integer)
            ~/.local/bin/nrfutil pkg generate --hw-version 52 --sd-req 0x00 \
              --application-version 1 \
              --application build/app/zephyr/zephyr.hex \
              mp_usb_${{ matrix.board }}_${COMMIT_SHA}.zip
            echo "‚úÖ ${{ matrix.board }} DFU: mp_usb_${{ matrix.board }}_${COMMIT_SHA}.zip"
          else
            # Copy and rename UF2 files with commit hash
            cp build/app/zephyr/zephyr.uf2 mp_usb_${{ matrix.board }}_${COMMIT_SHA}.uf2
            echo "‚úÖ ${{ matrix.board }} UF2: mp_usb_${{ matrix.board }}_${COMMIT_SHA}.uf2"
          fi

          ls -la mp_usb_*

          # Export COMMIT_SHA for use in next step
          echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV

      - name: üì¶ Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mp_usb_${{ matrix.board }}_${{ env.COMMIT_SHA }}
          path: /zephyr_workspace/mp_usb_${{ matrix.board }}_${{ env.COMMIT_SHA }}.*
          retention-days: 30

      - name: üîç Verify Build Artifacts
        run: |
          cd /zephyr_workspace
          if [ "${{ matrix.uses_dfu }}" = "true" ]; then
            echo "Checking for DFU package..."
            [ -f mp_usb_*.zip ] && echo '‚úì DFU package found' || echo '‚úó DFU package missing'
            echo 'DFU package:'
            ls -lh mp_usb_*.zip
          else
            echo "Checking for UF2 file..."
            [ -f build/app/zephyr/zephyr.uf2 ] && echo '‚úì zephyr.uf2 found' || echo '‚úó zephyr.uf2 missing'
            echo 'UF2 file size:'
            ls -lh build/app/zephyr/zephyr.uf2
            echo 'Renamed UF2 files:'
            ls -lh mp_usb_*.uf2
          fi
