name: Check & Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security scan
      run: |
        echo "Running security analysis..."
        # Check for common security issues in C code
        find ncs/app/src -name '*.c' -o -name '*.h' | xargs grep -l 'strcpy\|sprintf\|gets' || echo 'No obvious security issues found'

  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_changed: ${{ steps.check.outputs.changed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag comparison

      - name: Read VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "üì¶ Current VERSION: ${VERSION}"

      - name: Check if version tag exists
        id: check
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if tag exists (locally or remotely)
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  Version v${VERSION} already exists - skipping release"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚ú® New version v${VERSION} detected - will create release"
          fi

  build-nrf52:
    needs: [security-scan, check-version]
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/ci:v0.26.6
    env:
      CMAKE_PREFIX_PATH: /opt/toolchains
    strategy:
      matrix:
        board: [seeed_xiao_nrf52840, adafruit_feather_nrf52840, nordic_nrf52840dongle, aprbrother_nrf52840, raytac_mdbt50q_rx, raytac_mdbt50q_cx_40, makerdiary_nrf52840mdk]
        include:
          - board: seeed_xiao_nrf52840
            description: "Seeed XIAO nRF52840"
            board_target: xiao_ble
            overlay: seeed_xiao_nrf52840.overlay
            conf: seeed_xiao_nrf52840.conf
          - board: adafruit_feather_nrf52840
            description: "Adafruit Feather nRF52840 Express"
            board_target: adafruit_feather_nrf52840
          - board: nordic_nrf52840dongle
            description: "Nordic nRF52840 Dongle (PCA10059)"
            board_target: nrf52840dongle
            overlay: nordic_nrf52840dongle.overlay
            conf: nordic_nrf52840dongle.conf
          - board: aprbrother_nrf52840
            description: "April Brother nRF52840 Dongle"
            board_target: nrf52840dongle
            overlay: aprbrother_nrf52840.overlay
            conf: aprbrother_nrf52840.conf
          - board: raytac_mdbt50q_rx
            description: "Raytac MDBT50Q-RX Dongle"
            board_target: nrf52840dongle
            overlay: raytac_mdbt50q_rx.overlay
            conf: raytac_mdbt50q_rx.conf
          - board: raytac_mdbt50q_cx_40
            description: "Raytac MDBT50Q-CX-40 (Nordic DFU)"
            board_target: raytac_mdbt50q_cx_40/nrf52840
            overlay: raytac_mdbt50q_cx_40.overlay
            conf: raytac_mdbt50q_cx_40.conf
            uses_dfu: true
          - board: makerdiary_nrf52840mdk
            description: "MakerDiary nRF52840 MDK USB Dongle"
            board_target: nrf52840dongle
            overlay: makerdiary_nrf52840mdk.overlay
            conf: makerdiary_nrf52840mdk.conf

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: üíæ Cache Zephyr Workspace
        id: cache-workspace
        uses: actions/cache@v4
        with:
          path: /zephyr_workspace
          key: zephyr-workspace-ncs-v3.1.0-${{ runner.os }}
          restore-keys: |
            zephyr-workspace-ncs-v3.1.0-

      - name: ‚ôªÔ∏è Initialize Zephyr Workspace
        if: steps.cache-workspace.outputs.cache-hit != 'true'
        run: |
          mkdir -p /zephyr_workspace
          cd /zephyr_workspace
          west init -m https://github.com/nrfconnect/sdk-nrf.git --mr v3.1.0
          west update --narrow -o=--depth=1

      - name: üìÅ Copy App and Board Files to Workspace
        run: |
          rm -rf /zephyr_workspace/app
          rm -rf /zephyr_workspace/build
          # Create app directory structure matching local layout
          mkdir -p /zephyr_workspace/ncs
          cp -r ncs/app /zephyr_workspace/ncs/app
          cp VERSION /zephyr_workspace/VERSION
          # Symlink for compatibility with build commands
          ln -s /zephyr_workspace/ncs/app /zephyr_workspace/app

      - name: üíæ Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-v1-${{ runner.os }}-${{ matrix.board }}-${{ github.sha }}
          restore-keys: |
            ccache-v1-${{ runner.os }}-${{ matrix.board }}-
            ccache-v1-${{ runner.os }}-

      - name: üî® Build Project
        run: |
          cd /zephyr_workspace
          ccache -z

          # Build with overlay/conf if specified, otherwise use board defaults
          if [ -n "${{ matrix.overlay }}" ]; then
            echo "Building ${{ matrix.description }} with custom overlay/conf"
            west build \
                --board ${{ matrix.board_target }} \
                --pristine=always app \
                -- \
                -DBOARD_ROOT="/zephyr_workspace/ncs/app" \
                -DDTC_OVERLAY_FILE="/zephyr_workspace/ncs/app/boards/${{ matrix.overlay }}" \
                -DEXTRA_CONF_FILE="/zephyr_workspace/ncs/app/boards/${{ matrix.conf }}"
          else
            echo "Building ${{ matrix.description }} with board defaults"
            west build \
                --board ${{ matrix.board_target }} \
                --pristine=always app \
                -- \
                -DBOARD_ROOT="/zephyr_workspace/ncs/app"
          fi

          ccache -sv

      - name: üì¶ Prepare Firmware Artifacts
        run: |
          cd /zephyr_workspace
          VERSION="${{ needs.check-version.outputs.version }}"

          # Clean up any old firmware files from cached workspace
          rm -f mp_usb_*.uf2 mp_usb_*.zip mp_usb_*.hex

          # Check if this board uses DFU (Nordic bootloader)
          if [ "${{ matrix.uses_dfu }}" = "true" ]; then
            echo "üì¶ Creating DFU package for ${{ matrix.board }}..."
            # Install nrfutil if not present
            pip3 install --user nrfutil >/dev/null 2>&1 || true
            # Create DFU package for command-line flashing (application-version must be integer)
            ~/.local/bin/nrfutil pkg generate --hw-version 52 --sd-req 0x00 \
              --application-version 1 \
              --application build/app/zephyr/zephyr.hex \
              mp_usb_${VERSION}_${{ matrix.board }}.zip
            # Also copy HEX file for nRF Connect for Desktop Programmer (GUI)
            cp build/app/zephyr/zephyr.hex mp_usb_${VERSION}_${{ matrix.board }}.hex
            echo "‚úÖ ${{ matrix.board }} DFU ZIP: mp_usb_${VERSION}_${{ matrix.board }}.zip"
            echo "‚úÖ ${{ matrix.board }} HEX: mp_usb_${VERSION}_${{ matrix.board }}.hex"
          else
            # Copy and rename UF2 files with version number
            cp build/app/zephyr/zephyr.uf2 mp_usb_${VERSION}_${{ matrix.board }}.uf2
            echo "‚úÖ ${{ matrix.board }} UF2: mp_usb_${VERSION}_${{ matrix.board }}.uf2"
          fi

          ls -la mp_usb_*

      - name: üì¶ Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mp_usb_${{ matrix.board }}
          path: /zephyr_workspace/mp_usb_*
          retention-days: 90

  build-esp32:
    needs: [security-scan, check-version]
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        board:
          - name: seeed_xiao_esp32s3
            display_name: "Seeed XIAO ESP32-S3"
            sdkconfig: "sdkconfig.defaults;sdkconfig.board.xiao"
          - name: lilygo_tdisplay_s3
            display_name: "LilyGo T-Display-S3"
            sdkconfig: "sdkconfig.defaults;sdkconfig.board.lilygo"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build ${{ matrix.board.display_name }}
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: release-v6.0
          target: esp32s3
          path: esp
          command: |
            . ~/esp-idf/export.sh
            cd esp
            export SDKCONFIG_DEFAULTS="${{ matrix.board.sdkconfig }}"
            idf.py build

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          VERSION="${{ needs.check-version.outputs.version }}"

          # Copy app binary only (preserves NVS/BLE bonds when flashed at 0x10000)
          cp esp/build/mouthpad_usb.bin artifacts/mp_usb_${VERSION}_${{ matrix.board.name }}.bin

          echo "‚úÖ ${{ matrix.board.display_name }} app binary created"
          ls -lh artifacts/

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mp_usb_${{ matrix.board.name }}
          path: artifacts/mp_usb_*.bin
          if-no-files-found: error
          retention-days: 90

  create-release:
    needs: [check-version, build-nrf52, build-esp32]
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release package
        run: |
          mkdir -p release
          VERSION="${{ needs.check-version.outputs.version }}"

          echo "üì¶ Collecting firmware files for v${VERSION} release:"

          # Copy all firmware files from artifacts
          find artifacts -type f \( -name "*.uf2" -o -name "*.bin" -o -name "*.zip" -o -name "*.hex" \) -exec cp {} release/ \;

          echo ""
          echo "‚úÖ Release package contents:"
          ls -lh release/

          # Create checksums
          cd release
          sha256sum * > checksums.txt
          echo ""
          echo "üîê Checksums:"
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: MouthPad USB v${{ needs.check-version.outputs.version }}
          body: |
            ## MouthPad USB Firmware v${{ needs.check-version.outputs.version }}

            ### üì¶ Firmware Files

            **nRF52840 Boards (UF2 format - drag & drop to bootloader):**
            - `mp_usb_${{ needs.check-version.outputs.version }}_seeed_xiao_nrf52840.uf2` - Seeed XIAO nRF52840
            - `mp_usb_${{ needs.check-version.outputs.version }}_adafruit_feather_nrf52840.uf2` - Adafruit Feather nRF52840 Express
            - `mp_usb_${{ needs.check-version.outputs.version }}_nordic_nrf52840dongle.uf2` - Nordic nRF52840 Dongle
            - `mp_usb_${{ needs.check-version.outputs.version }}_aprbrother_nrf52840.uf2` - April Brother nRF52840 Dongle
            - `mp_usb_${{ needs.check-version.outputs.version }}_raytac_mdbt50q_rx.uf2` - Raytac MDBT50Q-RX Dongle
            - `mp_usb_${{ needs.check-version.outputs.version }}_makerdiary_nrf52840mdk.uf2` - MakerDiary nRF52840 MDK USB Dongle

            **nRF52840 Boards (Nordic DFU bootloader - Raytac CX-40):**
            - `mp_usb_${{ needs.check-version.outputs.version }}_raytac_mdbt50q_cx_40.hex` - HEX file (for nRF Connect Programmer GUI)
            - `mp_usb_${{ needs.check-version.outputs.version }}_raytac_mdbt50q_cx_40.zip` - DFU package (for command-line nrfutil)

            **ESP32-S3 Boards (BIN format - flash with esptool):**
            - `mp_usb_${{ needs.check-version.outputs.version }}_seeed_xiao_esp32s3.bin` - Seeed XIAO ESP32-S3
            - `mp_usb_${{ needs.check-version.outputs.version }}_lilygo_tdisplay_s3.bin` - LilyGo T-Display-S3

            ### üîß Installation

            **nRF52840 (UF2 - most boards):**
            1. Enter bootloader mode (double-tap reset button)
            2. Drag & drop the `.uf2` file to the mounted drive
            3. Device will automatically reboot with new firmware

            **nRF52840 (Nordic DFU for Raytac CX-40):**

            *Option 1 - GUI with HEX file (Recommended):*
            1. Download [nRF Connect for Desktop](https://www.nordicsemi.com/Products/Development-tools/nRF-Connect-for-Desktop)
            2. Install the "Programmer" app
            3. Put device in bootloader mode (hold RESET button while connecting USB)
            4. Select device in nRF Connect Programmer
            5. Add the `.hex` file and click "Write"

            *Option 2 - Command Line with ZIP package:*
            1. Install nrfutil: `pip install nrfutil`
            2. Put device in bootloader mode (hold RESET button while connecting USB)
            3. Flash: `nrfutil dfu serial -pkg mp_usb_<version>_raytac_mdbt50q_cx_40.zip -p <PORT>`
            4. Device will automatically reboot with new firmware

            **ESP32-S3 (BIN):**
            ```bash
            esptool.py --chip esp32s3 write_flash 0x10000 mp_usb_<version>_<board>.bin
            ```

            **Note:**
            - UF2 and DFU preserve Settings/NVS storage including BLE bonds
            - ESP32-S3: Flashing at 0x10000 (app partition) preserves NVS storage

            ### üîê Checksums
            See `checksums.txt` for SHA256 verification.
          files: |
            release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          echo "### ‚úÖ Release v${VERSION} Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`v${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Firmware files:** $(ls release/ | grep -E '\.(uf2|bin)$' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Release contents:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh release/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
