cmake_minimum_required(VERSION 3.16)

# Read VERSION file from repository root (before project setup)
set(VERSION_FILE "${CMAKE_CURRENT_SOURCE_DIR}/../VERSION")
if(EXISTS "${VERSION_FILE}")
  file(READ "${VERSION_FILE}" FIRMWARE_VERSION_STRING)
  string(STRIP "${FIRMWARE_VERSION_STRING}" FIRMWARE_VERSION_STRING)

  # Parse version string (e.g., "0.1.0" -> major=0, minor=1, patch=0)
  string(REGEX MATCH "^([0-9]+)\\.([0-9]+)\\.([0-9]+)" VERSION_MATCH "${FIRMWARE_VERSION_STRING}")
  if(VERSION_MATCH)
    set(VERSION_MAJOR ${CMAKE_MATCH_1})
    set(VERSION_MINOR ${CMAKE_MATCH_2})
    set(VERSION_PATCH ${CMAKE_MATCH_3})

    # Convert to BCD format for USB descriptor (e.g., 0.1.0 -> 0x0010)
    math(EXPR USB_BCD_DEVICE "(${VERSION_MAJOR} << 8) | (${VERSION_MINOR} << 4) | ${VERSION_PATCH}")
    math(EXPR USB_BCD_DEVICE_HEX "${USB_BCD_DEVICE}" OUTPUT_FORMAT HEXADECIMAL)

    message(STATUS "Firmware version: ${FIRMWARE_VERSION_STRING} (USB bcdDevice: ${USB_BCD_DEVICE_HEX})")
  else()
    message(WARNING "Invalid VERSION format: ${FIRMWARE_VERSION_STRING}")
  endif()
else()
  message(WARNING "VERSION file not found at ${VERSION_FILE}")
endif()

include($ENV{IDF_PATH}/tools/cmake/project.cmake)
project(mouthpad_usb)

# Pass version defines to compiler (after project setup when IDF functions are available)
if(DEFINED USB_BCD_DEVICE_HEX)
  idf_build_set_property(COMPILE_DEFINITIONS "-DFIRMWARE_VERSION_STRING=\"${FIRMWARE_VERSION_STRING}\"" APPEND)
  idf_build_set_property(COMPILE_DEFINITIONS "-DUSB_BCD_DEVICE=${USB_BCD_DEVICE_HEX}" APPEND)
endif()
